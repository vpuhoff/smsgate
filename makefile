lock:
	uv pip compile pyproject.toml -o requirements.txt

# Makefile –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic

# --------------------------------------------------------------------------- #
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# --------------------------------------------------------------------------- #

# –ò–º—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ Alembic.
# –ï—Å–ª–∏ alembic –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≤–∞—à–µ–º PATH, —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
ALEMBIC = alembic

# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫: make migrate m="add user table"
m := ""

# –î–ª—è —Ä–∞–±–æ—Ç—ã —Å Docker Compose. –ó–∞–º–µ–Ω–∏—Ç–µ `api` –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω alembic.
# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: make docker-migrate m="add products"
DOCKER_SERVICE_NAME = api
DOCKER_COMPOSE_RUN = docker-compose run --rm $(DOCKER_SERVICE_NAME)

# --------------------------------------------------------------------------- #
# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
# --------------------------------------------------------------------------- #

# .PHONY –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ make –Ω–µ –±—É–¥–µ—Ç –ø—É—Ç–∞—Ç—å —Ç–∞—Ä–≥–µ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –Ω–∞ –¥–∏—Å–∫–µ.
.PHONY: help init migrate upgrade downgrade-one downgrade-all history current stamp

# .DEFAULT_GOAL —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `help` –∫–∞–∫ –∫–æ–º–∞–Ω–¥—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `make`.
.DEFAULT_GOAL := help

help: ## ‚ú® –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
	@echo "Usage: make [target]"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
	sort | \
	awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

init: ## üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ Alembic (—Å–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'alembic')
	$(ALEMBIC) init alembic

migrate: ## üìù –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏. –¢—Ä–µ–±—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ. e.g. make migrate m="add user table"
	@if [ -z "$(m)" ]; then \
		echo "Error: –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏."; \
		echo "–ü—Ä–∏–º–µ—Ä: make migrate m=\"add user table\""; \
		exit 1; \
	fi
	$(ALEMBIC) revision --autogenerate -m "$(m)"

upgrade: ## ‚¨ÜÔ∏è –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ (head)
	$(ALEMBIC) upgrade head

upgrade-one: ## üîº –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –º–∏–≥—Ä–∞—Ü–∏—é (+1)
	$(ALEMBIC) upgrade +1

downgrade-one: ## üîΩ –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é (-1)
	$(ALEMBIC) downgrade -1

downgrade-all: ## üîª –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–æ base)
	$(ALEMBIC) downgrade base

history: ## üìö –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
	$(ALEMBIC) history --verbose

current: ## üìå –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏
	$(ALEMBIC) current

stamp: ## üèÅ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –≤ –ë–î –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é head)
	$(ALEMBIC) stamp head


# --------------------------------------------------------------------------- #
# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è Docker Compose
# --------------------------------------------------------------------------- #

.PHONY: docker-migrate docker-upgrade docker-downgrade-one docker-history docker-current

docker-migrate: ## üê≥üìù (Docker) –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é. e.g. make docker-migrate m="..."
	@if [ -z "$(m)" ]; then \
		echo "Error: –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏."; \
		echo "–ü—Ä–∏–º–µ—Ä: make docker-migrate m=\"add user table\""; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE_RUN) $(ALEMBIC) revision --autogenerate -m "$(m)"

docker-upgrade: ## üê≥‚¨ÜÔ∏è (Docker) –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
	$(DOCKER_COMPOSE_RUN) $(ALEMBIC) upgrade head
